<link rel="import" href="../bower_components/polymer/polymer-element.html">
<dom-module id="klog-data-editor">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
  </template>
  <script>
    class KlogDataEditor extends Polymer.Element {

      static get is() { return 'klog-data-editor'; }

      static get properties() {
        return {
          articleId: {
            type: String,
            notify: true,
          },
          markdown: {
            type: String,
            observer: '_markdownChanged',
            notify: true,
          },
          title: {
            type: String,
            observer: '_updateDisplayTitle',
            notify: true,
          },
          autoTitle: {
            type: String,
            value: '',
            notify: true,
          },
          displayTitle: {
            type: String,
            notify: true,
          },
          path: {
            type: String,
            observer: '_pathChanged',
            notify: true,
          },
          randomPath: {
            type: String,
            notify: true,
          },
          displayPath: {
            type: String,
            notify: true,
          },
          private: {
            type: Boolean,
            notify: true,
          },
          immersive: {
            type: Boolean,
            notify: true,
          },
          attachments: {
            type: Array,
            notify: true,
          },
          previews: {
            type: Array,
            notify: true,
          },
          currentLine: {
            type: String,
            observer: '_updatePreviews',
          },
          fileinfo: {
            type: Object,
            observer: '_updateFileinfo',
          }
        }
      }

      _markdownChanged() {
        let lexer = new marked.Lexer();
        let tokens = lexer.lex(this.markdown);
        this._updateAutoTitle(tokens);
        this._updateMeta(tokens);
        this._updateAttachments(tokens);
      }

      _updateAutoTitle(tokens) {
        let autoTitle = '';
        let depth = 7;
        for (let token of tokens) {
          if (token.type == 'heading' && token.depth < depth) {
            autoTitle = token.text;
            depth = token.depth;
            if (depth == 1) break
          }
        }
        this.autoTitle = autoTitle;
        this._updateDisplayTitle();
      }

      _updateDisplayTitle() {
        this.displayTitle = this.title || this.autoTitle.replace(/^\s+|\s+$/g, "") || '无题';
      }

      _updateMeta(tokens) {
        let text = '';
        let collection = '日常';
        let tags = [];
        let keywords = [];
        for (let token of tokens) {
          if (token.type == 'blockquote_start') text += '"';
          else if (token.type == 'blockquote_end') text = text.substr(0, text.length - 1) + '" ';
          else if (token.type == 'paragraph' || token.type == 'text') {
            //at
            let cap = token.text.match(/^@\(([\s\S]+?)\)(\[([\s\S]+?)\])?/);
            if (cap) {
              collection = cap[1] ? cap[1] : '';
              tags = cap[3] ? cap[3].split(',') : [];
              for (let i = 0; i < tags.length; i++) tags[i] = tags[i].trim().toLowerCase();
            }
            //summary
            if (text.length > 300) continue
            let out = [].concat(token.text
              .replace(/@\(([\s\S]*?)\)(\[([\s\S]*?)\])?/g, '') // at
              .replace(/\[toc\]/ig, '') // toc
              .replace(/\${1,2}([\s\S]+?)\${1,2}/g, '\\[$1\\]') // katex
              .replace(/~{1,2}[\s\S]+~{1,2}/g, '\\[Biii\\]') // del
              .replace(/!\[(.*)\]\(.*\)/g, '\\[图片\\]$1') // image
              .replace(/\[<V>.*\]\(.*\)/g, '\\[视频\\]') // video
              .replace(/\[(.*)\]\(.*\)/g, '$1') // link
              .match(/\\[<!\[\]_~\*`\$]|[^<!\[\]_~\*`\$]/g))
              .join('')
              .replace(/\\([\\`*{}\[\]\$()#+\-.!_>~|])/g, '$1')
              .replace(/\n/g, '');
            text += out ? out + ' ' : '';
          }
          else if (token.type == 'heading') {
            keywords.push(this.unescape(token.text));
          }
        }
        text = text.trim();
        this.text = text;
        this.collection = collection;
        this.tags = tags;
        this.keywords = keywords;
      }

      _updateAttachments(tokens) {
        let renderer = new marked.Renderer();
        this.attachments = [];
        renderer.image = (href, title, text) => {
          let attachment = {
            image: true,
            url: href,
            text: this.unescape(text),
          }
          if (title) {
            attachment.title = title;
          }
          this.push('attachments', attachment);
          return '';
        };
        let Inlinelexer = new marked.InlineLexer(tokens.links, { gfw: true, renderer: renderer });
        for (let token of tokens) {
          if (token.type == 'paragraph') {
            Inlinelexer.output(token.text);
          }
        }
      }

      _updatePreviews(currentLine) {
        let lexer = new marked.Lexer();
        let tokens = lexer.lex(currentLine);
        let renderer = new marked.Renderer();
        this.previews = [];
        renderer.image = (href, title, text) => {
          let preview = {
            image: true,
            url: href,
            text: this.unescape(text),
          }
          if (title) {
            preview.title = title;
          }
          this.push('previews', preview);
          return '';
        };
        let Inlinelexer = new marked.InlineLexer(tokens.links, { gfw: true, renderer: renderer });
        Inlinelexer.output(currentLine);
      }

      unescape(html) {
        // explicitly match decimal, hex, and named HTML entities
        return html.replace(/&(#(?:\d+)|(?:#x[0-9A-Fa-f]+)|(?:\w+));?/g, function (_, n) {
          n = n.toLowerCase();
          if (n === 'colon') return ':';
          if (n.charAt(0) === '#') {
            return n.charAt(1) === 'x' ?
              String.fromCharCode(parseInt(n.substring(2), 16)) :
              String.fromCharCode(+n.substring(1));
          }
          return '';
        });
      }

      _generateRandomPath() {
        this.randomPath = 'article-' + Math.floor(Math.random() * 1000000 + 100000);
        this._pathChanged();
      }

      _pathChanged() {
        this.displayPath = this.path || this.randomPath || '';
        var query = new AV.Query('Article');
        query.equalTo('path', this.displayPath);
        query.select(['path']);
        query.find().then((results) => {
          if (results.length == 0) return
          if (!this.path && !this.articleId) {
            this._generateRandomPath();
          } else {
            this.err = '路径不可用，请换一个( ´ー`)';
          }
        }, (err) => console.log(err));
      }

      _updateFileinfo(fileinfo) {
        let url = fileinfo.host + '/' + fileinfo.key;
        let mimeType = fileinfo.mimeType;
        let out;
        if (mimeType.indexOf('image') > -1) {
          out = `![](${url})`;
        } else if (mimeType.indexOf('video') > -1) {
          out = `[<V>${fileinfo.fname}](${url})`;
        } else {
          out = `[${fileinfo.fname}](${url})`;
        }
        if (this.markdown) out = '\n' + out
        this.editor.$.textarea.insertLine('', out);
        //console.log('write:', fileinfo);
      }

      reset() {
        this.articleId = '';
        this.markdown = '@(笔记)[]';
        this.title = null;
        this._generateRandomPath();
        this.path = null;
        this.previews = [];
        this.attachments = [];
        this.immersive = false;
      }

      load(id) {
        var article = AV.Object.createWithoutData('Article', this.articleId);
        return article.fetch()
          .then(data => {
            if (!data.get('updatedAt')) {
              this.dispatchEvent(new CustomEvent('klog-app-load', { bubbles: true, composed: true, detail: { page: 'editor/' } }));
              this.reset();
              return
            }
            data = Object.assign({ private: true, immersive: false }, data.toJSON());
            if (data.author.objectId != this.userinfo.publicinfo.id) {
              this.dispatchEvent(new CustomEvent('klog-app-load', { bubbles: true, composed: true, detail: { page: '404' } }));
            }
            this.markdown = data.markdown;
            this.path = data.path;
            this.randomPath = data.path;
            this.private = data.immersive ? true : data.private;
            this.immersive = data.immersive;
            this._pathChanged();
            setTimeout(() => {
              if (this.autoTitle == data.title) {
                // 自动生成标题
                this.title = ''
              } else {
                // 自定义标题
                this.title = data.title
              }
            }, 1);
          });
      }

      save() {
        // create or update
        let article;
        if (this.markdown == '') return Promise.reject('球球李写点什么吧！');
        if (this.articleId) {
          article = AV.Object.createWithoutData('Article', this.articleId);
        } else {
          article = new AV.Object('Article');
        }
        this.path = this.displayPath;
        // pointer
        let topic = AV.Object.createWithoutData('Topic', '59bcb4d3128fe158340be1b5');
        let author = AV.Object.createWithoutData('UserPublic', this.userinfo.publicinfo.id);
        // set attributes
        article.set('author', author);
        article.set('title', this.title || this.autoTitle);
        article.set('markdown', this.markdown);
        article.set('text', this.text);
        article.set('path', this.path || this.randomPath);
        article.set('private', this.immersive || this.private);
        article.set('immersive', this.immersive);
        article.set('image', this.attachments[0]);
        article.set('attachments', this.attachments);
        article.set('collection', this.collection);
        article.set('tags', this.tags);
        article.set('keywords', this.keywords);
        article.set('comments', []);
        article.set('topic', topic);
        //save
        return article.save();
      }

      delete() {
        let article = AV.Object.createWithoutData('Article', this.articleId);
        return article.destroy()
      }

    }

    window.customElements.define(KlogDataEditor.is, KlogDataEditor);
  </script>
</dom-module>