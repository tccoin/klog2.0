<link rel="import" href="../bower_components/polymer/polymer-element.html">
<dom-module id="klog-data-image">
  <template>
    <style>
      :host {
        display: block;
        overflow: hidden;
      }

      /* :host([theme="dark"]) img {
        filter: grayscale(30%);
      } */

      img {
        display: block;
        max-width: 100%;
        width: var(--klog-media-override-width, auto);
        border-radius: var(--klog-image-border-radius, 0px);
        z-index: 0;
      }

      :host([content]) img {
        max-width: var(--klog-media-width, 100%);
      }

      :host([lazy]) img {
        opacity: 0;
      }

      :host #bg {
        opacity: 1;
        display: block;
        position: relative;
        max-width: var(--klog-media-width, 100%);
        width: var(--klog-media-override-width, auto);
        border-radius: var(--klog-image-border-radius, 0px);
        transition: opacity 1s ease;
        z-index: 1;
      }


      :host([avatar]) {
        width: 32px;
        height: 32px;
        margin-right: 8px;
        flex-shrink: 0;
        --klog-image-border-radius: 50%;
      }
    </style>
    <img id="img" src="{{_src}}" />
    <div id="bg"></div>
  </template>
  <script>
    class KlogDataImage extends Polymer.Element {

      static get is() { return 'klog-data-image'; }

      static get properties() {
        return {
          src: {
            type: String,
            reflectToAttribute: true,
            observer: 'srcChanged',
          },
          avatar: {
            type: Boolean,
            reflectToAttribute: true,
          },
          timeline: {
            type: Boolean,
            reflectToAttribute: true,
          },
          editor: {
            type: Boolean,
            reflectToAttribute: true,
          },
          content: {
            type: Boolean,
            reflectToAttribute: true,
          },
          content: {
            type: Boolean,
            reflectToAttribute: true,
          },
          gallery: {
            type: Boolean,
            reflectToAttribute: true
          },
          theme: {
            type: String
          }
        }
      }

      srcChanged(src) {
        if (!src) return;
        this._initQueue();
        // process url
        let oriSrc = src;
        if (this.avatar && !src) {
          src = 'https://klog2.oss-cn-hangzhou.aliyuncs.com/img/default_avatar.jpg';
        } else if (this.content && src.indexOf('clouddn.com') > -1 && !src.indexOf(/\.svg$/)) {
          src += '?imageView2/2/w/1440/q/85/interlace/1';
        } else if (src.indexOf('storage.krrr.party') > -1 && src.indexOf('gif') == -1) {
          let result = src.replace(/(\?.*)?$/, '').match(/(.*\/)(.*)$/);
          src = result[1] + encodeURIComponent(result[2]);
          if (this.avatar) {
            src += '?Magic/1/w/100/h/100/q/90';
          } else if (this.timeline) {
            src += '?Magic/1/w/320/h/180/q/75';
          } else if (this.content) {
            src += '?Magic/2/w/1440/q/90';
          } else if (this.gallery) {
            // src += '?Magic/1/w/584/h/584/q/75';
            src += '?Magic/1/w/274/h/274/q/75';
          }
          if (this.lazy) {
            // disable image
            this.wasLazy = true;
            this._lazySrc = src;
            src = '';
            this.loadPlaceholder(oriSrc + '?Magic/6');
          }
        }
        // set property
        if (this.lazy) {
          this._src = src
        } else {
          this._addToQueue(resolve => {
            this._src = src;
            this.$.img.onload = resolve;
            this.$.img.onerror = resolve;
          });
        }
      }

      _initQueue() {
        if (!window._imageLoadingQueue) {
          window._imageLoadingCount = 0;
          window._imageLoadingQueue = [];
          for (let i = 0; i < 5; i++) {
            window._imageLoadingQueue.push(Promise.resolve());
          }
        }
      }

      _addToQueue(cb) {
        const queue = window._imageLoadingQueue;
        const count = window._imageLoadingCount;
        queue[count] = queue[count].then(() => new Promise(cb));
        window._imageLoadingCount = window._imageLoadingCount == 4 ? 0 : window._imageLoadingCount + 1;
      }

      ready() {
        super.ready();
        //window resize
        window.addEventListener('resize', () => {
          if (this.wasLazy)
            this.updatePlaceholder();
        });
      }

      loadPlaceholder(url) {
        this.$.bg.style.height = '300px';
        this.$.bg.style.width = "1000px";
        let req = new XMLHttpRequest();
        req.onload = () => {
          this._placeholderData = JSON.parse(req.response);
          this.updatePlaceholder();
        };
        req.open('get', url, true);
        req.send();
      }

      updatePlaceholder() {
        let data = this._placeholderData;
        let mediaWidth = getComputedStyle(this).getPropertyValue('--klog-media-width');
        let maxWidth = parseInt(mediaWidth);
        if (!mediaWidth) {
          this.$.bg.style.width = `0px`;
          this.$.bg.style.height = `0px`;
          this.$.img.style.position = `initial`;
        } else {
          let w = Math.min(maxWidth, data.w);
          let h = w / data.w * data.h;
          this.$.bg.style.width = `${w}px`;
          this.$.bg.style.height = `${h}px`;
          this.$.img.style.position = 'absolute';
        }
        let c = this.theme == 'light' ? data.palette.LightVibrant.rgb : data.palette.DarkVibrant.rgb;
        this.$.bg.style.backgroundColor = `rgb(${c[0]},${c[1]},${c[2]})`;
        this.$.img.style.backgroundColor = `rgb(${c[0]},${c[1]},${c[2]})`;
      }

      lazyload() {
        setTimeout(() => {
          this.lazy = false;
          // this.$.img.style.position = 'absolute';
          this.src = this._lazySrc;
          this.$.img.onload = () => this.$.bg.style.opacity = 0;
        }, 1);
      }

    }

    window.customElements.define(KlogDataImage.is, KlogDataImage);
  </script>
</dom-module>