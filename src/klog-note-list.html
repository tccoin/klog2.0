<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-layout/app-layout.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="klog-style-scrollbar.html">
<link rel="import" href="klog-style-toolbar.html">
<link rel="import" href="klog-icons.html">
<link rel="import" href="klog-data-list.html">
<link rel="import" href="klog-note-item.html">
<link rel="import" href="klog-note-search.html">
<dom-module id="klog-note-list">
  <template>
    <style include="klog-style-scrollbar"></style>
    <style include="klog-style-toolbar"></style>
    <style>
      :host {
        width: var(--klog-note-list-width);
        flex-shrink: 0;
        border-right: 1px solid var(--divider-color);
        height: calc(100vh - 64px);
      }

      /*container*/
      .main-container {
        position: relative;
        max-height: calc(var(--klog-pages-height) - 64px);
        z-index: 2;
        overflow-x: hidden;
        overflow-y: auto;
        opacity: 1;
        transition: opacity .1s ease;
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;
        overscroll-behavior: contain;
      }

      :host([loading]) .main-container {
        opacity: 0;
      }

      .spinner-container {
        @apply(--fit-layout);
        top: 64px;
        z-index: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--primary-background-color);
        opacity: 0;
        transition: opacity .2s ease;
        --paper-spinner-color: var(--secondary-text-color);
      }

      :host([loading]) .spinner-container {
        opacity: 1;
      }

      /*header*/
      .header-container {
        position: fixed;
        width: var(--klog-note-list-width);
        top: 0px;
        z-index: 100;
        left: 0;
        transition: all .15s ease;
        cursor: default;
        border-radius: 12px 0 0 0;
        @apply(--shadow-none);
      }

      .header-container::after {
        content: '';
        position: absolute;
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
        z-index: -1;
        background-color: var(--primary-background-color);
        border-radius: 12px 0 0 0;
        opacity: var(--klog-header-opacity, 1);
      }

      .header-container.raised {
        border-bottom: none;
        @apply(--shadow-elevation-2dp);
      }

      .header-container .title {
        display: block;
        width: calc(100% - 56px);
        box-sizing: border-box;
        font-size: 20px;
        padding: 12px 16px 12px;
        color: var(--secondary-text-color);
        font-weight: bold;
        line-height: 38px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .header-container paper-icon-button {
        background: var(--secondary-text-color);
        color: var(--primary-background-color);
        border-radius: 50%;
        width: 22px;
        height: 22px;
        padding: 2px;
        margin: 8px;
        line-height: 0;
        opacity: 0.3;
      }

      :host([gesture]) .gesture-indicator {
        display: block;
        position: absolute;
        top: 8px;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        height: 4px;
        width: 24px;
        background-color: var(--overlay-background);
        opacity: var(--overlay-opacity);
        border-radius: 2px;
        transition: opacity .1s ease;
      }

      :host([gesture][moving]) .gesture-indicator {
        opacity: var(--secondary-overlay-opacity);
      }

      .header-container klog-note-search {
        width: 100%;
        padding: 0 16px 16px;
        box-sizing: border-box;
      }

      /*list*/

      .items {
        position: relative;
        padding-top: 118px;
        overflow-x: hidden;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }

      .items .divider {
        height: 1px;
        background: var(--divider-color);
        margin: 0 16px;
      }

      .items .divider:first-child {
        display: none;
      }

      @media (max-width: 767px) {
        .header-container {
          width: 100%;
          border-radius: 12px 12px 0 0;
        }

        .header-container::after {
          border-radius: 12px 12px 0 0;
        }

        .header-container .title {
          font-size: 16px;
          padding: 8px 16px;
        }

        .main-container {
          max-height: calc(var(--klog-pages-height) - 64px);
        }

        .items {
          padding-top: 100px;
        }

        .spinner-container {
          top: 100px;
        }
      }
    </style>

    <klog-data-list id="data" last-response="{{list}}" loading="{{loading}}" userinfo="{{userinfo}}"
      keyword="{{keyword}}" collection="{{collection}}" stt="{{stt}}"></klog-data-list>

    <div class="header-container" id="header">
      <!-- <div class="gesture-indicator"></div> -->
      <div class="title">{{title}}</div>
      <klog-note-search id="search" keyword="{{keyword}}" userinfo="{{userinfo}}" on-click="search"></klog-note-search>
    </div>

    <div class="spinner-container">
      <paper-spinner-lite active></paper-spinner-lite>
    </div>

    <div class="main-container" id="scrollTarget">
      <div class="items" id="items">
        <template is="dom-repeat" items="{{items}}">
          <div class="divider"></div>
          <klog-note-item class="item" data="{{item}}" collection="{{collection}}"></klog-note-item>
        </template>
      </div>
    </div>

  </template>
  <script>
    class KlogNoteList extends Polymer.Element {

      static get is() { return 'klog-note-list'; }

      static get properties() {
        return {
          loading: {
            type: Boolean,
            reflectToAttribute: true
          },
          gesture: {
            type: Boolean,
            reflectToAttribute: true
          },
          moving: {
            type: Boolean,
            reflectToAttribute: true
          },
          keyword: {
            type: String,
            notify: true
          },
          list: {
            type: Array,
            observer: '_loadNewPage'
          },
          collection: {
            type: String,
            notify: true
          },
          title: {
            type: String,
          }
        }
      }

      static get observers() {
        return [
          'load(keyword, collection)',
          'updateTitle(keyword,collection)'
        ]
      }

      openDrawer() {
        this.dispatchEvent(new CustomEvent('drawer-toggle', { bubbles: true, composed: true }));
      }

      ready() {
        super.ready();
        //events
        this.$.scrollTarget.addEventListener('scroll', () => {
          if (this._scrollingTimeout) { window.clearTimeout(this._scrollingTimeout) }
          this._scrollingTimeout = setTimeout(() => {
            this.scroll(false);
          }, 150);
          this.scroll(true);
        });
        this.addEventListener('touchstart', e => {
          this._isMoving = true;
        });
        this.addEventListener('touchend', e => {
          this._isMoving = false;
          this.scroll(false);
        });
        this.$.header.addEventListener('touchstart', e => {
          this.dispatchEvent(new CustomEvent('klog-backdrop-touchstart', { bubbles: true, composed: true, detail: { touches: e.touches } }));
        });

        //page loader
        this._initPageloader();

        // observer for container height
        let MutationObserver = window.MutationObserver || window.WebKitMutationObserver || window.MozMutationObserver
        let observer = new MutationObserver(() => this.updateContainer());
        observer.observe(this.$.items, { childList: true })
      }

      scroll(isScrolling) {
        let y = this.$.scrollTarget.scrollTop;
        if (!this._searchHeight) this.updateContainer();
        let threshold = this._searchHeight;
        isScrolling = !!(isScrolling || this._isMoving);
        // scroll according to the threshold
        if (!isScrolling) {
          if (y < threshold * 0.7) this.$.scrollTarget.scrollTop = 0;
          else if (y < threshold) this.$.scrollTarget.scrollTop = threshold;
        }
        // raise the header
        if (y >= threshold) this.$.header.classList.add('raised');
        else this.$.header.classList.remove('raised');
        // searchbar animation
        this.$.search.setWidth(this.offsetWidth - 40);
        this.$.search.setAnimation(1 - y / threshold);
        // focus event
        if (y == 0 && this._waitingToFocus) {
          this._waitingToFocus = false;
          this.$.search.focus();
        }
        // blur
        // if (this.userinfo.preference && this.userinfo.preference.backdropBlurEnabled) {
        //   let isLight = this.theme == 'light';
        //   let process = Math.min(y / threshold, 1);
        //   this.updateStyles({ '--klog-header-opacity': process * (isLight ? 0.4 : 0.8) });
        //   this.$.header.style.backdropFilter = `saturate(180%) blur(${y > threshold ? process * (isLight ? 10 : 15) : 0}px)`;
        //   this.$.header.style.webkitBackdropFilter = `saturate(180%) blur(${y > threshold ? process * (isLight ? 10 : 15) : 0}px)`;
        // } else {
        this.updateStyles({ '--klog-header-opacity': 1 });
        this.$.header.style.backdropFilter = 'initial';
        this.$.header.style.webkitBackdropFilter = 'initial';
        // }
      }

      load() {
        this.$.scrollTarget.scrollTop = 0;
        this.$.scrollTarget.addEventListener('scroll', this._pageScrollHandler);
        this.$.data.load().then(list => {
          if (!list) return;
          let isMobile = this.mobile;
          let isOnly = list.length == 1;
          let isSearching = this.keyword != '';
          let hasPath = Boolean(this.path);
          if (isMobile && isSearching && isOnly || !isMobile && isSearching) {
            // 加载第一项：手机上搜索时只有一个结果；电脑上搜索时
            this.dispatchEvent(new CustomEvent('app-load', {
              detail: {
                page: 'note/' + this.collection + '/' + list[0].path
              }, bubbles: true, composed: true
            }));
          } else if (!isMobile && !isSearching && !hasPath) {
            // 加载非置顶的第一项
            let topArticleIndex = 0;
            for (let i = 0; i < list.length; i++) {
              if (!list[i].stt) {
                topArticleIndex = i;
                break;
              }
            }
            this.dispatchEvent(new CustomEvent('app-load', {
              detail: {
                page: 'note/' + this.collection + '/' + list[topArticleIndex].path
              }, bubbles: true, composed: true
            }));
          }
        });
      }

      unload() {
        this.$.scrollTarget.removeEventListener('scroll', this._pageScrollHandler);
      }

      updateContainer() {
        if (!this._searchHeight) this._searchHeight = this.$.search.getBoundingClientRect().height;
        let scrollTargetHeight = this.$.scrollTarget.getBoundingClientRect().height;
        let itemsComputedStyle = getComputedStyle(this.$.items);
        let itemsHeight = parseFloat(itemsComputedStyle.height) + parseFloat(itemsComputedStyle.paddingTop);
        let threshold = this._searchHeight;
        if (itemsHeight > scrollTargetHeight) {
          let padding = Math.max(threshold - (itemsHeight - scrollTargetHeight), 0);
          this.$.items.style.paddingBottom = padding + 'px';
        }
      }

      search() {
        this._waitingToFocus = true;
        this.$.scrollTarget.scrollTop = 0;
      }

      updateTitle(keyword, collection) {
        let title;
        if (keyword) title = `搜索“${keyword}”`;
        else if (collection == 'all') title = '所有笔记';
        else if (collection) title = collection;
        this.title = title;
      }

      _initPageloader() {
        this._pageSize = 20;
        this._resetPage();
        this._pageScrollHandler = e => {
          let y = this.$.scrollTarget.scrollTop;
          let wh = this.scrollHeight;         // container height
          let eh = this.$.items.scrollHeight; // element height
          if (y + wh * 1.4 >= eh) {
            this._loadNextPage();
          }
        };
      }

      _loadNewPage(list) {
        this._items = list;
        this._resetPage();
        this._loadNextPage();
      }

      _resetPage() {
        this._pageNumber = 0;
        this._eof = false;
      }

      _loadNextPage() {
        this._pageNumber++;
        this.items = this._items.slice(0, this._pageNumber * this._pageSize);
        if (this._pageNumber * this._pageSize >= this._items.length) {
          this._eof = true;
        }
      }
    }

    window.customElements.define(KlogNoteList.is, KlogNoteList);
  </script>
</dom-module>