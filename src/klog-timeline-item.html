<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-layout/app-layout.html">
<link rel="import" href="../bower_components/paper-ripple/paper-ripple.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="klog-icons.html">
<link rel="import" href="klog-data-timeline.html">
<link rel="import" href="klog-image.html">
<link rel="import" href="klog-style-card.html">
<link rel="import" href="klog-timeline-attachments.html">
<link rel="import" href="klog-render-timestamp.html">
<dom-module id="klog-timeline-item">
  <template>
    <style include="klog-style-card"></style>
    <style>
      :host {
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: default;
        width: 100%;
        color: var(--primary-text-color);
        --primary-font-size: 14px;
        --secondary-font-size: 12px;
        --klog-media-transition-time: .2s;
        user-select: none;
        -webkit-user-select: none;
      }

      a {
        text-decoration: none;
        width: 100%;
        display: block;
        color: inherit -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
        -webkit-tap-highlight-color: transparent;
      }

      .card {
        width: calc(100% - 16px);
        margin: auto;
        cursor: pointer;
        background: var(--klog-theme-surface);
        /* background: transparent;
        border: 1px solid var(--border-color, --divider-color);
        @apply --shadow-none; */
        overflow: hidden;
        -webkit-tap-highlight-color: transparent;
        transition: box-shadow .3s ease;
      }

      .card:hover {
        @apply --shadow-elevation-8dp;
      }

      /*card-meta*/

      .card-meta {
        display: flex;
        align-items: center;
        font-size: 0.9em;
        line-height: 1;
        margin: calc(var(--klog-card-padding) * 2);
        color: var(--secondary-text-color);
      }

      .card-meta .meta-avatar {
        width: 32px;
        height: 32px;
      }

      .card-meta .meta-content {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .meta-title {
        font-weight: bold;
        color: var(--primary-text-color);
        font-size: var(--primary-font-size);
      }

      .meta-subtitle {
        display: flex;
        flex-flow: row;
        align-items: center;
        white-space: nowrap;
        font-size: var(--primary-font-size);
        margin-top: 4px;
      }

      .meta-collection {
        color: var(--dark-primary-color);
      }

      .meta-subtitle .divider {
        display: inline-block;
        height: 4px;
        width: 4px;
        margin: 0 6px;
        border-radius: 2px;
        background: var(--border-color);
      }


      /*card-body*/

      .card-media {
        max-height: 328px;
        margin: 0;
        --klog-media-override-width: 100%;
      }

      .card-subtitle {
        margin: calc(var(--klog-card-padding) * 3) calc(var(--klog-card-padding) * 2) 0;
        line-height: 1;
        color: var(--secondary-text-color);
        font-weight: bold;
      }

      .card-media:not([hidden])+.card-subtitle {
        margin: calc(var(--klog-card-padding) * 2) calc(var(--klog-card-padding) * 2) 0;
      }

      .card-title {
        color: var(--primary-text-color);
        margin-top: var(--klog-card-padding) !important;
      }

      .card-subtitle+.card-title {
        margin-top: calc(var(--klog-card-padding) * 0.5) !important;
      }

      .card-content {
        display: flex;
        flex-direction: row;
      }

      .content-text {
        max-height: 6.8em;
        overflow: hidden;
        flex: 1;
        margin: 0;
        font-size: var(--primary-font-size);
        color: var(--klog-card-content-color, var(--primary-text-color));
      }

      .content-thumbnail {
        width: 160px;
        height: 90px;
        border-radius: 3px;
        margin-left: calc(var(--klog-card-padding) * 2);
      }

      /*card-gallery*/

      .card-gallery {
        @apply --layout-horizontal;
        @apply --layout-start-center;
        flex-wrap: wrap;
        overflow: auto;
        flex: 1;
        margin: calc(var(--klog-card-padding) * 2);
        font-size: var(--secondary-font-size);
        color: var(--klog-card-content-color, var(--primary-text-color));
      }

      .card-gallery-item {
        margin-right: 1px;
        margin-top: 1px;
        flex-grow: 0;
        flex-shrink: 0;
        flex-basis: calc(25% - 1px);
      }

      :host([mobile]) .card-gallery-item {
        flex-basis: calc(33.33% - 1px);
      }

      .card-gallery-item[large] {
        flex-basis: calc(50% - 1px);
      }

      .attachments {
        position: relative;
        margin-top: 0;
        margin-bottom: 0;
        overflow: hidden;
      }

      /*card-actions*/

      .card-actions {
        display: flex;
        flex-wrap: wrap;
        margin-bottom: calc(var(--klog-card-padding) * 2 - 4px) !important;
        color: var(--secondary-text-color);
        overflow: hidden;
        transition: height .2s ease;
      }

      .card-actions>paper-chip {
        max-width: 268px;
        min-width: 80px;
        margin: 0 8px 4px 0;
        --paper-chip-icon-size: 20px;

        --paper-chip-style: {
          font-size: var(--secondary-font-size);
          padding: 3px 10px;
        }
      }

      .card-actions>paper-chip[animated] {
        transition: all .2s ease;
      }

      .card-actions>paper-chip[more] {
        margin-right: 0;
        min-width: 0;
        width: 52px;
      }

      .card-actions>paper-chip[more][hidden] {
        display: initial !important;
        transform: scale(0);
        opacity: 0;
        width: 0;
      }

      [hidden] {
        display: none !important;
      }

      @media (max-width: 632px) {
        .card-actions>paper-chip {
          max-width: calc(50vw - 32px);
        }
      }
    </style>
    <!--header-->
    <a href="/#/article/{{data.path}}" id="card">
      <div class="card klog-card" raised$="{{expended}}" on-click="read">

        <!--meta-->
        <div class="card-meta">
          <klog-image class="meta-avatar" src="{{data.author.avatarUrl}}" theme="{{theme}}" lazy fixed avatar>
          </klog-image>
          <div class="meta-content">
            <div class="meta-title">{{data.author.displayName}}</div>
          </div>
          <div class="meta-date">
            <klog-render-timestamp time-stamp="{{data.date}}"></klog-render-timestamp>
          </div>
        </div>

        <!--media-->
        <klog-image class="card-media" src="{{data.image.url}}" hidden$="{{!view.fullWidthMedia}}" theme="{{theme}}"
          lazy content>
        </klog-image>

        <!--title-->
        <div class="card-subtitle" hidden$="{{!data.title}}">{{data.collection}}</div>
        <h1 class="card-title" hidden$="{{!data.title}}">{{data.title}}</h1>

        <!--content-->
        <div class="card-content" hidden$="{{!data._text}}">
          <p class="content-text" id="text">{{data._text}}</p>
          <template is="dom-if" if="{{view.thumbnail}}">
            <klog-image class="content-thumbnail" src="{{data.image.url}}" theme="{{theme}}" lazy fixed timeline>
            </klog-image>
            </klog-image>
          </template>
        </div>

        <!--gallery-->
        <template is="dom-if" if="{{view.gallery}}">
          <div class="card-gallery">
            <template is="dom-repeat" items="{{gallery}}">
              <klog-image class="card-gallery-item" src="{{item.url}}" theme="{{theme}}" lazy fixed gallery
                large$="{{item.large}}">
              </klog-image>
            </template>
          </div>
        </template>

        <!--actions-->
        <div class="card-actions" hidden$="{{!view.actions}}">
          <template is="dom-repeat" items="{{actions}}">
            <template is="dom-if" if="{{item.file}}">
              <paper-chip outlined icon="inbox" href="{{item.url}}" label="{{item.text}}"></paper-chip>
            </template>
            <template is="dom-if" if="{{item.link}}">
              <paper-chip outlined icon="link" href="{{item.url}}" label="{{item.text}}"></paper-chip>
            </template>
            <template is="dom-if" if="{{item.more}}">
              <paper-chip outlined icon="more_horiz" more animated on-click="expand"></paper-chip>
            </template>
          </template>
        </div>

      </div>
    </a>
  </template>
  <script src="../static/lib/Clamp.js/clamp.min.js"></script>
  <script>
    class KlogTimelineItem extends Polymer.Element {

      static get is() { return 'klog-timeline-item'; }

      static get properties() {
        return {
          data: {
            type: Object,
          },
          view: {
            type: Object
          },
          mobile: {
            type: Boolean,
            reflectToAttribute: true
          },
        }
      }

      static get observers() {
        return [
          'refresh(data.attachments)'
        ]
      }

      ready() {
        super.ready();
        window.addEventListener('resize', () => {
          if (this._resizeTimeout) {
            clearTimeout(this._resizeTimeout);
          }
          this._resizeTimeout = setTimeout(() => this.refresh(), 100);
        });
      }

      has(sth) {
        return !(sth == false)
      }

      read() {
        this.dispatchEvent(new CustomEvent('app-load', { bubbles: true, composed: true, detail: { page: 'article/' + this.data.path, now: false } }));
      }

      refresh() {
        this.refreshPromise = new Promise((resolve) => {
          setTimeout(() => {
            this.view = {
              gallery: false,
              fullWidthMedia: false,
              thumbnail: false,
              actions: true
            };
            const promises = [];
            // update styles
            promises.push(
              this._calculateAttachments()
                .then(() => this._calculateCardStyle())
                .then(() => this._updateActionsContainer())
            );
            // clamp
            let text = this.$.card.querySelector('#text');
            if (text) {
              promises.push(Promise.resolve($clamp(text, { clamp: 4 })));
            }
            Promise.all(promises).then(resolve);
          }, 1);
        });
        return this.refreshPromise;
      }

      _calculateCardStyle() {
        // 识别只有图片的文章等
        return new Promise((resolve) => {
          const view = this.view;
          const data = this.data;
          const text = this.data.text || '';
          const shortenText = text.replace(/\[图片\]/g, '').trim();
          const gallery = this.gallery;
          const actions = this.actions;
          /*避免修改原数据*/
          data._text = data.text;
          /* 可用性 */
          view.thumbnail = Boolean(data.image.url);
          view.fullWidthMedia = Boolean(data.image.url);
          view.actions = actions.length != 0;
          /* 显示相册 */
          if (gallery.length >= 3) {
            view.gallery = true;
            view.fullWidthMedia = false;
            view.thumbnail = false;
            view.actions = false;
            data._text = shortenText;
          }
          /* 显示缩略图或大图 */
          if (!view.gallery) {
            if (shortenText.length > 40) {
              view.fullWidthMedia = false;
            } else {
              data._text = shortenText;
              view.thumbnail = false;
            }
          }
          /*更新样式*/
          this.notifyPath('data._text');
          this.notifyPath('view.actions');
          this.notifyPath('view.gallery');
          this.notifyPath('view.thumbnail');
          this.notifyPath('view.fullWidthMedia');
          setTimeout(resolve, 1);
        });
      }

      _calculateAttachments() {
        return new Promise((resolve) => {
          // gallery
          let gallery = this.data.attachments.filter(x => x.image);
          this.imageCount = gallery.length;
          gallery.splice(this.mobile ? 6 : 8);
          // if (gallery.length >= 1 && gallery.length <= 3) {
          //   gallery[0].large = true;
          // }
          this.hiddenImageCount = this.imageCount - gallery.length;
          this.gallery = gallery;
          // links
          let links = this.data.attachments.filter(x => x.link);
          this.links = links;
          // files
          let files = this.data.attachments.filter(x => x.file);
          this.files = files;
          // actions
          let actions = files.concat(links);
          this.actions = actions;
          this.notifyPath('actions');
          setTimeout(resolve, 1);
        });
      }

      _updateActionsContainer() {
        if (this.actions.filter(x => x.more).length > 0) return;
        const actionsContainer = this.$.card.querySelector('.card-actions');
        actionsContainer.style.height = 'initial';
        if (this._shrinkedChip) {
          this._shrinkedChip.removeAttribute('style');
        }
        return new Promise((resolve) => {
          setTimeout(() => {
            const actionsContainer = this.$.card.querySelector('.card-actions');
            let chips = Array.from(actionsContainer.querySelectorAll('paper-chip:not([style^=display])'));
            let remainWidth = actionsContainer.offsetWidth;
            for (let i = 0; i < chips.length; i++) {
              let chip = chips[i];
              if (chip.offsetTop != chips[0].offsetTop) {
                this.splice('actions', i, 0, { more: true });
                this._shrinkedChip = chips[i - 1];
                this._shrinkedChipWidth = chips[i - 1].offsetWidth;
                this._shrinkedChip.style.maxWidth = (this._shrinkedChip.offsetWidth - (remainWidth - 60 >= 0 ? 0 : 60 - remainWidth)) + 'px';
                this._remainWidth = remainWidth;
                actionsContainer.style.height = (chips[0].offsetHeight + 3) + 'px';
                break;
              }
              remainWidth -= chip.offsetWidth + 8;
            }
            setTimeout(() => {
              const elements = actionsContainer.querySelectorAll('[more]');
              for (let element of elements) {
                element.hidden = false;
              }
              resolve();
            }, 1);
          }, 1);
        });
      }

      lazyload() {
        setTimeout(() => {
          const images = this.$.card.querySelectorAll('klog-image:not([hidden])');
          for (let image of images) {
            image.lazyload();
          }
        }, 1);
      }

      expand(e) {
        e.stopPropagation();
        e.preventDefault();
        const actionsContainer = this.$.card.querySelector('.card-actions');
        const more = e.target;
        const last = Array.from(actionsContainer.querySelectorAll('paper-chip')).pop();
        let height = last.offsetTop + last.offsetHeight - actionsContainer.offsetTop + 8;
        actionsContainer.style.height = `${height}px`;
        this._shrinkedChip.setAttribute('animated', true);
        this._shrinkedChip.removeAttribute('style');
        this._shrinkedChip.style.width = this._shrinkedChipWidth + 'px';
        more.hidden = true;
      }
    }

    window.customElements.define(KlogTimelineItem.is, KlogTimelineItem);
  </script>
</dom-module>