<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-layout/app-layout.html">
<link rel="import" href="../bower_components/paper-ripple/paper-ripple.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="klog-icons.html">
<link rel="import" href="klog-data-timeline.html">
<link rel="import" href="klog-data-image.html">
<link rel="import" href="klog-style-card.html">
<link rel="import" href="klog-timeline-attachments.html">
<link rel="import" href="klog-render-timestamp.html">
<dom-module id="klog-timeline-item">
  <template>
    <style include="klog-style-card"></style>
    <style>
      :host {
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: default;
        width: 100%;
        --app-grid-columns: 3;
        --app-grid-item-height: 100%;
        --app-grid-gutter: 1px;
        --secondary-font-size: 14px;
      }

      a {
        text-decoration: none;
        width: 100%;
        display: block;
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
        -webkit-tap-highlight-color: transparent;
      }

      .card {
        width: calc(100% - 16px);
        margin: auto;
        cursor: pointer;
        background: var(--klog-theme-surface);
        overflow: hidden;
        -webkit-tap-highlight-color: transparent;
        transition: box-shadow .3s ease;
      }

      .card:hover {
        @apply --shadow-elevation-8dp;
      }

      /*card-meta*/

      .card-meta {
        display: flex;
        align-items: center;
        line-height: 1.3;
        margin: 0 !important;
        padding: calc(var(--klog-card-padding) * 2);
        color: var(--secondary-text-color);
        font-size: var(--secondary-font-size);
      }

      .card-meta .date {
        white-space: nowrap;
      }

      .card-meta .meta {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .meta-name {
        margin-right: 4px;
        font-weight: bold;
        color: var(--primary-text-color);
      }

      .meta-collection {
        white-space: nowrap;
      }


      /*card-body*/

      .card-title {
        color: var(--primary-text-color);
        margin-top: var(--klog-card-padding) !important;
      }

      .card-title+.card-content {
        margin-top: 0;
      }

      .card-content {
        display: flex;
        flex-direction: row;
      }

      .content-text {
        max-height: 6.8em;
        overflow: hidden;
        flex: 1;
        margin: 0;
        padding-right: calc(var(--klog-card-padding) * 2);
        font-size: var(--secondary-font-size);
        color: var(--klog-card-content-color, var(--primary-text-color));
      }

      .content-thumbnail {
        width: 160px;
        height: 90px;
        border-radius: 3px;
      }

      /*card-attachments*/

      .card-gallery {
        @apply --layout-horizontal;
        @apply --layout-start-center;
        flex-wrap: wrap;
        overflow: auto;
        flex: 1;
        margin: 0;
        font-size: var(--secondary-font-size);
        color: var(--klog-card-content-color, var(--primary-text-color));
      }

      .card-gallery-item {
        margin-right: 1px;
        margin-top: 1px;
        flex-grow: 1;
        flex-shrink: 0;
        flex-basis: calc(33% - 0.7px);
      }

      .card-gallery-item:nth-child(even) {
        margin-right: 0;
      }

      .attachments {
        position: relative;
        margin-top: 0;
        margin-bottom: 0;
        overflow: hidden;
      }

      /*card-actions*/

      .card-actions {
        display: flex;
        flex-wrap: wrap;
        margin-bottom: calc(var(--klog-card-padding) * 2 - 4px) !important;
        color: var(--secondary-text-color);
        overflow: hidden;
        transition: height .2s ease;
      }

      .card-actions>paper-chip {
        max-width: 268px;
        min-width: 80px;
        margin: 0 8px 4px 0;
        --paper-chip-icon-size: 20px;

        --paper-chip-style: {
          font-size: 12px;
          padding: 4px 10px;
        }
      }

      .card-actions>paper-chip[animated] {
        transition: all .2s ease;
      }

      .card-actions>paper-chip[more] {
        margin-right: 0;
        min-width: 0;
        width: 52px;
      }

      .card-actions>paper-chip[more][hidden] {
        display: initial !important;
        transform: scale(0);
        opacity: 0;
        width: 0;
      }

      .divider {
        flex: 1;
      }

      [hidden] {
        display: none !important;
      }

      @media (max-width: 632px) {
        .card-actions>paper-chip {
          max-width: calc(50vw - 32px);
        }
      }
    </style>
    <!--header-->
    <a href="/#/article/{{data.path}}">
      <div class="card klog-card" raised$="{{expended}}" on-click="read" id="card">
        <div class="card-meta">
          <klog-data-image class="meta-avatar" src="{{data.author.avatarUrl}}" avatar></klog-data-image>
          <div class="meta">
            <span class="meta-name">{{data.author.displayName}}</span>
            <span class="meta-collection">
              <template is="dom-if" if="{{data.view.gallery}}">发布了{{imageCount}}张照片</template>
              <template is="dom-if" if="{{data.view.default}}">发布在&nbsp;{{data.collection}}</template>
            </span>
          </div>
          <div class="date">
            <klog-render-timestamp time-stamp="{{data.date}}"></klog-render-timestamp>
          </div>
        </div>
        <!--default view-->
        <template is="dom-if" if="{{data.view.default}}">
          <h1 class="card-title" hidden$="{{!data.title}}">{{data.title}}</h1>
          <div class="card-content" hidden$="{{!data.text}}">
            <p class="content-text" id="text">{{data.text}}</p>
            <template is="dom-if" if="{{data.image.url}}">
              <klog-data-image class="content-thumbnail" src="{{data.image.url}}" timeline></klog-data-image>
            </template>
          </div>
          <template is="dom-if" if="{{actions}}">
            <div class="card-actions">
              <template is="dom-repeat" items="{{actions}}">
                <template is="dom-if" if="{{item.file}}">
                  <paper-chip outlined icon="inbox" href="{{item.url}}" label="{{item.text}}"></paper-chip>
                </template>
                <template is="dom-if" if="{{item.link}}">
                  <paper-chip outlined icon="link" href="{{item.url}}" label="{{item.text}}"></paper-chip>
                </template>
                <template is="dom-if" if="{{item.more}}">
                  <paper-chip outlined icon="more_horiz" more animated on-click="expand"></paper-chip>
                </template>
              </template>
          </template>
      </div>

  </template>
  <!--gallery view-->
  <template is="dom-if" if="{{data.view.gallery}}">
    <h1 class="card-title" hidden$="{{!data.title}}">{{data.title}}</h1>
    <div class="card-gallery">
      <template is="dom-repeat" items="{{gallery}}">
        <klog-data-image class="card-gallery-item" src="{{item.url}}" gallery></klog-data-image>
      </template>
    </div>
  </template>
  </div>
  </a>
  </template>
  <script src="../static/lib/Clamp.js/clamp.min.js"></script>
  <script>
    class KlogTimelineItem extends Polymer.Element {

      static get is() { return 'klog-timeline-item'; }

      static get observers() {
        return [
          'refresh(data.attachments)'
        ]
      }

      ready() {
        super.ready();
        window.addEventListener('resize', () => {
          if (this._resizeTimeout) {
            clearTimeout(this._resizeTimeout);
          }
          this._resizeTimeout = setTimeout(() => this.refresh(), 100);
        });
      }

      has(sth) {
        return !(sth == false)
      }

      read() {
        this.dispatchEvent(new CustomEvent('klog-app-load', { bubbles: true, composed: true, detail: { page: 'article/' + this.data.path, now: false } }));
      }

      refresh() {
        return new Promise((resolve) => {
          setTimeout(() => {
            const promises = [];
            // update styles
            promises.push(
              this._calculateAttachments()
                .then(() => this._updateActionsContainer())
            );
            // clamp
            let text = this.$.card.querySelector('#text');
            if (text) {
              promises.push(Promise.resolve($clamp(text, { clamp: 4 })));
            }
            Promise.all(promises).then(resolve);
          }, 1);
        });
      }

      _calculateAttachments() {
        return new Promise((resolve) => {
          // gallery
          let gallery = this.data.attachments.filter(x => x.image);
          this.imageCount = gallery.length;
          if (this.imageCount == 4) gallery.splice(3);
          else if (this.imageCount == 7) gallery.splice(6);
          else gallery.splice(9);
          this.hiddenImageCount = this.imageCount - gallery.length;
          this.gallery = gallery;
          // links
          let links = this.data.attachments.filter(x => x.link);
          this.links = links;
          // files
          let files = this.data.attachments.filter(x => x.file);
          this.files = files;
          // actions
          let actions = files.concat(links);
          this.actions = actions;
          this.notifyPath('actions');
          this.notifyPath('data.view');
          setTimeout(resolve, 1);
        });
      }

      _updateActionsContainer() {
        if (this.actions.filter(x => x.more).length > 0) return;
        const actionsContainer = this.$.card.querySelector('.card-actions');
        actionsContainer.removeAttribute('style');
        if (this._shrinkedChip) {
          this._shrinkedChip.removeAttribute('style');
        }
        console.log(this, this.actions);
        return new Promise((resolve) => {
          setTimeout(() => {
            const actionsContainer = this.$.card.querySelector('.card-actions');
            let chips = Array.from(actionsContainer.querySelectorAll('paper-chip:not([style^=display])'));
            let remainWidth = actionsContainer.offsetWidth;
            for (let i = 0; i < chips.length; i++) {
              let chip = chips[i];
              if (chip.offsetTop != chips[0].offsetTop) {
                this.splice('actions', i, 0, { more: true });
                this._shrinkedChip = chips[i - 1];
                this._shrinkedChipWidth = chips[i - 1].offsetWidth;
                this._shrinkedChip.style.maxWidth = (this._shrinkedChip.offsetWidth - (remainWidth - 60 >= 0 ? 0 : 60 - remainWidth)) + 'px';
                this._remainWidth = remainWidth;
                actionsContainer.style.height = (chips[0].offsetHeight + 3) + 'px';
                break;
              }
              remainWidth -= chip.offsetWidth + 8;
            }
            setTimeout(() => {
              const elements = actionsContainer.querySelectorAll('[more]');
              for (let element of elements) {
                element.hidden = false;
              }
              resolve();
            }, 1);
          }, 1);
        });

      }

      expand(e) {
        e.stopPropagation();
        e.preventDefault();
        const actionsContainer = this.$.card.querySelector('.card-actions');
        const more = e.target;
        const last = Array.from(actionsContainer.querySelectorAll('paper-chip')).pop();
        let height = last.offsetTop + last.offsetHeight - actionsContainer.offsetTop + 8;
        actionsContainer.style.height = `${height}px`;
        this._shrinkedChip.setAttribute('animated', true);
        this._shrinkedChip.removeAttribute('style');
        this._shrinkedChip.style.width = this._shrinkedChipWidth + 'px';
        more.hidden = true;
      }
    }

    window.customElements.define(KlogTimelineItem.is, KlogTimelineItem);
  </script>
</dom-module>