<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-layout/app-layout.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="klog-style-scrollbar.html">
<link rel="import" href="klog-style-toolbar.html">
<link rel="import" href="klog-icons.html">
<link rel="import" href="klog-data-article.html">
<link rel="import" href="klog-markdown.html">
<dom-module id="klog-note-content">
  <template>
    <style include="klog-style-scrollbar"></style>
    <style include="klog-style-toolbar"></style>
    <style>
      :host {
        flex: 1;
        height: calc(100vh - 64px);
        outline: none;
      }

      /*container*/

      .main-container {
        position: relative;
        max-height: 100%;
        z-index: 2;
        overflow: auto;
        background: var(--primary-background-color);
        opacity: 1;
        transition: opacity .2s ease;
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;
        overscroll-behavior: contain;
      }

      :host([loading]) .main-container {
        opacity: 0;
      }

      .spinner-container {
        @apply(--fit-layout);
        z-index: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--primary-background-color);
        opacity: 0;
        transition: opacity .2s ease;
        --paper-spinner-color: var(--secondary-text-color);
      }

      :host([loading]) .spinner-container {
        opacity: 1;
      }

      /*content*/

      app-toolbar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 100;
        background: var(--primary-background-color);
        color: var(--secondary-text-color);
        @apply(--shadow-none);
        transition: all .15s ease-out;
      }

      app-toolbar::after {
        content: '';
        @apply(--swipe-indicator);
      }

      :host(:not([mobile])) app-toolbar {
        position: absolute;
        width: auto;
        z-index: 10;
        top: 0;
        left: auto;
        right: 0;
        margin: 16px;
        height: 36px;
        padding: 0 4px;
        border-radius: 18px;
        color: var(--secondary-text-color);
        background: var(--secondary-background-color);
      }

      :host(:not([mobile])) app-toolbar paper-icon-button {
        height: 36px;
        width: 36px;
        flex-basis: 36px;
        padding: 9px;
        line-height: 0;
      }

      :host([mobile]) app-toolbar.raised {
        @apply(--shadow-elevation-4dp);
      }

      :host(:not([mobile])) app-toolbar.raised {
        @apply(--shadow-elevation-2dp);
      }

      @media (min-width: 768px) {
        [mobile] {
          display: none !important;
        }
      }

      @media (max-width: 767px) {
        :host {
          height: 100vh;
        }

        .main-container {
          padding-top: 64px;
          height: calc(100vh - 64px);
        }
      }
    </style>

    <klog-data-article key="updatedAt" path="{{path}}" last-response="{{article}}" loading="{{loading}}"
      last-error="{{error}}" userinfo="{{userinfo}}" type="user" default="{{!mobile}}">
    </klog-data-article>

    <div class="spinner-container">
      <paper-spinner-lite active></paper-spinner-lite>
    </div>

    <app-toolbar id="notetool" short>
      <paper-icon-button icon="arrow_back" on-click="back" mobile></paper-icon-button>
      <div class="divider"></div>
      <div class="actions">
        <paper-icon-button icon="edit" on-click="edit"></paper-icon-button>
        <paper-icon-button icon="share" on-click="share"></paper-icon-button>
        <paper-icon-button icon="{{bookmarksIcon}}" on-click="toggleBookmark"></paper-icon-button>
      </div>
    </app-toolbar>

    <div class="main-container" id="scrollTarget">
      <div class="body">
        <klog-markdown class="markdown" id="markdown" markdown="{{article.markdown}}" link-prefix="article/{{path}}"
          theme="{{theme}}" scroll-bias="{{_getBias(mobile)}}" preference="{{userinfo.preference.markdown}}" breadcrumbs
          heading-actions>
        </klog-markdown>
      </div>
    </div>

  </template>
  <script>
    class KlogNoteContent extends Polymer.Element {

      static get is() { return 'klog-note-content'; }

      static get properties() {
        return {
          mobile: {
            type: Boolean,
            reflectToAttribute: true
          },
          loading: {
            type: Boolean,
            reflectToAttribute: true
          },
          keyword: {
            type: String,
            notify: true
          },
          collection: {
            type: String,
            notify: true
          },
          selected: {
            type: Number,
            notify: true
          },
          bookmarksIcon: {
            type: String,
            value: 'bookmark_border'
          },
          bookmarks: {
            type: Array
          },
          path: {
            type: String,
            notify: true
          }
        }
      }

      static get observers() {
        return [
          'loaded(article.objectId)'
        ]
      }

      ready() {
        super.ready();
        this.$.markdown.updateScrollTarget(this.$.scrollTarget);
        this.setAttribute('tabindex', 1);
        this.$.scrollTarget.addEventListener('scroll', () => {
          let y = this.$.scrollTarget.scrollTop;
          if (y > 0) {
            if (!this.mobile) {
              this.$.notetool.classList.add('raised');
            } else {
              this.$.notetool.setAttribute('collapsed', '');
            }
          } else {
            this.$.notetool.classList.remove('raised');
            this.$.notetool.removeAttribute('collapsed');
          }
        });
        this.$.markdown.addEventListener('markdown-rendered', () => {
          const elements = this.$.markdown.$.content.querySelectorAll('.tag,.collection');
          for (let element of elements) {
            element.addEventListener('click', e => this._setFilter(e));
          }
        });
      }

      share() {
        this.dispatchEvent(new CustomEvent('note-share', { bubbles: true, composed: true, detail: { path: this.article.path } }));
      }

      edit() {
        this.dispatchEvent(new CustomEvent('editor-open', {
          bubbles: true, composed: true, detail: {
            articleId: this.article.objectId,
            backTo: window.location.hash
          }
        }));
      }

      back() {
        this.dispatchEvent(new CustomEvent('app-load', { bubbles: true, composed: true, detail: { page: 'note/' + this.collection + '/' } }));
      }

      load(path) {
        if (window.location.hash.indexOf('#/note') == -1) return;
        this.path = path || '';
        this.selected = path ? 1 : 0;
      }

      loaded(articleId) {
        this.articleId = articleId;
        //bookmarks
        this._updateBookmarksIcon(this._calcBookmarkPosition(this.articleId, this.bookmarks) > -1);
        //clean state
        this.$.scrollTarget.scrollTop = 0;
      }

      toggleBookmark() {
        let bookmarks = this.bookmarks;
        let articleId = this.articleId;
        let bookmarkPosition = this._calcBookmarkPosition(this.articleId, this.bookmarks);
        if (bookmarkPosition > -1) {
          bookmarks.splice(bookmarkPosition, 1);
        } else {
          bookmarks.push({
            id: this.articleId,
            title: this.article.title,
            path: this.article.path,
            addedAt: new Date().toUTCString()
          });
        }
        let klogUser = this.userinfo.klogUser;
        let newPreference = Object.assign({}, this.userinfo.preference, { bookmarks: bookmarks });
        klogUser.update({ preference: { value: newPreference } });
        this.bookmarks = bookmarks;
        this.dispatchEvent(new CustomEvent('update-bookmarks', { bubbles: true, composed: true, detail: { bookmarks: bookmarks } }));
        this._updateBookmarksIcon(bookmarkPosition == -1);
      }

      _calcBookmarkPosition(articleId, bookmarks) {
        for (let i = 0; i < bookmarks.length; i++) {
          if (bookmarks[i].id == articleId) { return i; }
        }
        return -1;
      }

      _updateBookmarksIcon(marked) {
        this.bookmarksIcon = marked ? 'bookmark' : 'bookmark_border';
      }

      _isNull(arr = []) {
        return arr.length == 0;
      }

      _uppercase(str) {
        return str.toUpperCase();
      }

      _getBias(mobile) {
        return mobile ? -64 : 0;
      }

      _setFilter(e) {
        if (e.target.className == 'tag') {
          this.keyword = e.target.innerText;
          this.selected = 0;
        } else if (e.target.className == 'collection') {
          this.collection = e.target.innerText;
          this.selected = 0;
        }
      }

    }

    window.customElements.define(KlogNoteContent.is, KlogNoteContent);
  </script>
</dom-module>