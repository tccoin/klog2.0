<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-layout/app-layout.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/app-storage/app-localstorage/app-localstorage-document.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/paper-ripple/paper-ripple.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../bower_components/paper-radio-group/paper-radio-group.html">

<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">

<link rel="import" href="klog-icons.html">
<link rel="import" href="klog-style-card.html">
<link rel="import" href="klog-style-toolbar.html">
<link rel="import" href="klog-style-dialog.html">
<link rel="import" href="klog-style-form.html">
<link rel="import" href="klog-render-timestamp.html">
<link rel="import" href="klog-upload-zone.html">
<link rel="import" href="klog-data-user.html">
<link rel="import" href="klog-input.html">
<link rel="import" href="klog-dropdown-menu.html">
<dom-module id="klog-userpanel">
  <template>
    <style include="klog-style-card"></style>
    <style include="klog-style-toolbar"></style>
    <style include="klog-style-dialog"></style>
    <style include="klog-style-form"></style>
    <style>
      :host {
        display: block;
        background: var(--klog-page-background);
        padding: 64px 0 32px 0 !important;
      }

      app-toolbar {
        position: fixed;
        top: 0;
        background: transparent;
      }

      .divider {
        flex: 1;
      }

      .userpanel-card {
        max-width: 400px;
        width: calc(100% - 16px);
        margin: 0 auto 32px;
        border-radius: 5px;
        box-sizing: border-box;
        background-color: var(--primary-background-color);
        transition: all .15s ease-out;
        @apply --shadow-elevation-2dp;
      }

      .userpanel-card:last-child {
        margin-bottom: 0;
      }

      .userpanel-card .card-meta.header {
        padding: 8px 16px 8px 24px;
        display: flex;
        align-items: center;
        min-height: 56px;
        box-sizing: border-box;
      }

      .userpanel-card .card-meta.header .title {
        color: var(--secondary-text-color);
        font-weight: bold;
      }

      .userpanel-card .card-meta.header paper-icon-button {
        color: var(--primary-color);
      }

      .form>* {
        margin: 0 24px;
        padding-bottom: 16px;
      }

      .form>.fit {
        margin: 0 8px;
      }

      klog-upload-zone {
        width: 200px;
      }

      /*animation*/

      :host([exit]) .klog-card {
        opacity: 0;
        transform: translateY(5vh);
      }
    </style>
    <klog-data-user id="user" disabled></klog-data-user>

    <div class="userpanel-card klog-card">
      <div class="card-meta header">
        <div class="title">公开信息</div>
      </div>
      <div class="form">
        <klog-input label="头像路径" value="{{userinfo.avatarUrl}}" outlined hidden>
        </klog-input>
        <klog-input label="昵称" on-change="updatePublicinfo" value="{{userinfo.displayName}}" outlined></klog-input>
        <klog-input label="个人介绍" value="{{userinfo.introduction}}" outlined></klog-input>

        <div class="form-item">
          <div class="text-container">
            <span class="title">上传头像</span>
          </div>
          <paper-button on-click="openUploadAvatarDialog">
            <iron-icon icon="cloud_upload"></iron-icon>
          </paper-button>
        </div>
        <div class="fit">
        </div>
      </div>
    </div>

    <div class="userpanel-card klog-card">
      <div class="card-meta header">
        <div class="title">外观</div>
      </div>
      <div class="form">
        <klog-dropdown-menu label="主题" outlined vertical-align="top" horizontal-align="left" vertical-offset="62"
          horizontal-offset="-16">
          <paper-tabs selected="{{preference.theme}}" slot="dropdown-content" class="dropdown-content"
            attr-for-selected="name">
            <paper-tab name="light">浅色</paper-tab>
            <paper-tab name="dark">深色</paper-tab>
            <paper-tab name="system">跟随系统</paper-tab>
            <paper-tab name="time">根据时间</paper-tab>
          </paper-tabs>
        </klog-dropdown-menu>

        <div class="form-item">
          <div class="text-container">
            <span class="title">毛玻璃效果</span><br>
            <span class="description">实验性</span>
          </div>
          <paper-toggle-button checked="{{preference.backdropBlurEnabled}}"></paper-toggle-button>
        </div>
        <div class="fit">
        </div>
      </div>


      <!-- <paper-toggle-button checked="{{preference.darkThemeDisabled}}">没有黑夜</paper-toggle-button> -->
      <!-- <paper-toggle-button checked="{{preference.gestureDisabled}}">手势什么的最讨厌了</paper-toggle-button> -->
    </div>
    <div class="fit"></div>
    </div>

    <div class="userpanel-card klog-card" id="animation">
      <div class="card-meta header">
        <div class="title">阅读偏好</div>
      </div>
      <div class="form">
        <klog-dropdown-menu label="标题序号" outlined vertical-align="top" horizontal-align="left" vertical-offset="62"
          horizontal-offset="-16">
          <paper-tabs selected="{{preference.markdown.numberedHeading}}" slot="dropdown-content"
            class="dropdown-content" attr-for-selected="name">
            <paper-tab name="true">显示</paper-tab>
            <paper-tab name="auto">自动</paper-tab>
            <paper-tab name="false">隐藏</paper-tab>
          </paper-tabs>
        </klog-dropdown-menu>
        <klog-dropdown-menu label="标题位置" outlined vertical-align="top" horizontal-align="left" vertical-offset="62"
          horizontal-offset="-16">
          <paper-tabs selected="{{preference.markdown.centeredHeading}}" slot="dropdown-content"
            class="dropdown-content" attr-for-selected="name">
            <paper-tab name="false">正常</paper-tab>
            <paper-tab name="true">居中</paper-tab>
          </paper-tabs>
        </klog-dropdown-menu>
        <klog-dropdown-menu label="大段代码" outlined vertical-align="top" horizontal-align="left" vertical-offset="62"
          horizontal-offset="-16">
          <paper-tabs selected="{{preference.markdown.overflowCode}}" slot="dropdown-content" class="dropdown-content"
            attr-for-selected="name">
            <paper-tab name="true">滚动</paper-tab>
            <paper-tab name="false">全部显示</paper-tab>
          </paper-tabs>
        </klog-dropdown-menu>

        <div class="form-item">
          <div class="text-container">
            <span class="title">重设</span><br>
            <span class="description">恢复默认</span>
          </div>
          <paper-button on-click="resetMarkdownPreference">
            <iron-icon icon="settings_backup_restore"></iron-icon>
          </paper-button>
        </div>
        <div class="fit"></div>
      </div>
    </div>

    <!-- <div class="userpanel-card klog-card">
      <div class="card-meta header">
        <div class="title">启动时打开</div>
      </div>
      <div class="form">
        <paper-radio-group selected="{{preference.defaultPage}}">
          <paper-radio-button name="timeline">时间轴</paper-radio-button>
          <paper-radio-button name="note">笔记</paper-radio-button>
        </paper-radio-group>
      </div>
      <div class="fit"></div>
    </div> -->

    <paper-dialog id="uploadAvatarDialog" with-backdrop>
      <klog-upload-zone bucketname="klog-avatar" fileinfo="{{avatarinfo}}"></klog-upload-zone>
    </paper-dialog>
  </template>
  <script>
    class KlogUserpanel extends Polymer.Element {

      static get is() {
        return 'klog-userpanel';
      }

      static get properties() {
        return {
          layout: {
            type: Object,
            value: {
              documentTitle: '个人设置 - Klog',
              drawer: 'auto',
              menu: 'auto',
              scrollToTop: false,
              header: {
                fixed: true,
                short: false,
                shadow: 'off',
              },
              styles: {
                '--klog-header-background-color': 'transparent',
                '--klog-header-text-color': 'var(--primary-text-color)',
              },
              toolbar: Polymer.html`
                <app-toolbar>
                  <paper-icon-button icon="menu" name="drawer-button"></paper-icon-button>
                    <div class="title">
                      <div main-title>Klog</div>
                    </div>
                  <div class="divider"></div>
                  <paper-button on-click="logout">
                    <iron-icon icon="power_settings_new"></iron-icon>注销
                  </paper-button>
                </app-toolbar>`
            }
          },
        }
      }

      static get observers() {
        return [
          'updateAvatarUrl(avatarinfo)',
          'updatePreference(preference.theme,preference.defaultPage,preference.backdropBlurEnabled,preference.markdown.numberedHeading,preference.markdown.centeredHeading,preference.markdown.overflowCode)',
        ]
      }

      load(userLoadPromise) {
        if (!this.login) {
          return userLoadPromise.then(result => {
            if (!result.login) {
              this.dispatchEvent(new CustomEvent('user-login-page-open', {
                bubbles: true,
                composed: true
              }));
              return Promise.reject(new Error('Not Login.'))
            } else {
              this.preference = result.userinfo.preference;
              this.userinfo = result.userinfo;
              this.login = result.login;
            }
          });
        }
      }

      ready() {
        super.ready();
        this.$.uploadAvatarDialog.addEventListener('opened-changed', e => {
          this.dispatchEvent(new CustomEvent('backdrop-opened-changed', {
            bubbles: true,
            composed: true,
            detail: { value: e.detail.value }
          }));
        });
      }

      openDrawer() {
        this.dispatchEvent(new CustomEvent('drawer-toggle', {
          bubbles: true,
          composed: true
        }));
      }

      logout() {
        this.userinfo.klogUser.logout();
        this.dispatchEvent(new CustomEvent('user-login-page-open', {
          bubbles: true,
          composed: true,
          detail: {
            continue: '#/timeline/'
          }
        }));
      }

      newArticle() {
        this.dispatchEvent(new CustomEvent('app-load', {
          bubbles: true,
          composed: true,
          detail: {
            page: 'editor/'
          }
        }));
      }

      resetMarkdownPreference() {
        this.set("preference.markdown", this.$.user.defaultMarkdownPreference);
      }

      loadList() {
        this.$.data.load();
      }

      parseDate(date) {
        return Date.parse(date)
      }

      openUploadAvatarDialog() {
        this.$.uploadAvatarDialog.open();
      }

      updateAvatarUrl(avatarinfo) {
        this.userinfo.avatarUrl = avatarinfo.host + '/' + avatarinfo.key;
        console.log(this.userinfo.avatarUrl);
        this.$.uploadAvatarDialog.close();
        this.updatePublicinfo();
      }

      _updateUserinfo(info) {
        let klogUser = this.userinfo.klogUser;
        klogUser.update(info).then(() => {
          this.showToast('已更新账户');
          klogUser.updateUserinfo();
        });
      }

      showToast(text, link) {
        this.dispatchEvent(new CustomEvent('show-toast', {
          bubbles: true,
          composed: true,
          detail: {
            text: text,
            link: link
          }
        }));
      }

      updatePublicinfo() {
        let newInfo = {
          displayName: {
            publicRead: true,
            value: this.userinfo.displayName
          },
          introduction: {
            publicRead: true,
            value: this.userinfo.introduction
          },
          avatarUrl: {
            publicRead: true,
            value: this.userinfo.avatarUrl
          },
        };
        this._updateUserinfo(newInfo);
      }

      updatePreference() {
        if (!this._preferenceInit) {
          this._preferenceInit = true;
          return;
        }
        this.userinfo.preference = this.preference;
        this._updateUserinfo({
          preference: {
            value: this.preference
          }
        });
      }

    }

    window.customElements.define(KlogUserpanel.is, KlogUserpanel);
  </script>
</dom-module>