<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="klog-style-card.html">
<dom-module id="klog-data-user">
  <script>
    'user strict';
    /*
     * Use this element to do everything about the user account.
     */
    class KlogDataUser extends Polymer.Element {

      static get is() { return 'klog-data-user'; }

      static get properties() {
        return {
          user: {
            type: Object,
            observer: 'updateUserinfo'
          },
          userinfo: {
            type: Object,
            notify: true
          },
          email: {
            type: String,
            value: 'test@krrr.party'
          },
          password: {
            type: String,
            value: '123456'
          },
          log: {
            type: Boolean,
            value: false
          },
          disabled: {
            type: Boolean,
            value: false
          },
        }
      }

      ready() {
        super.ready();
        this.defaultMarkdownPreference = {
          numberedHeading: 'auto',
          centeredHeading: 'false',
          overflowCode: 'true'
        };
        this.defaultPreference = {
          theme: 'time',
          darkThemeDisabled: false,
          gestureDisabled: false,
          backdropBlurEnabled: false,
          defaultPage: 'timeline',
          stt: [],
          markdown: this.defaultMarkdownPreference
        };
        if (!this.disabled) {
          if (AV.User.current()) this.user = AV.User.current();
          this.updateUserinfo();
        }
      }

      updateUserinfo() {
        if (!this.user) {
          this.userinfo = { preference: this.defaultPreference };
          return;
        }
        this.user.fetch()
          .then((user) => {
            let userJson = user.toJSON();
            let preference = Object.assign(this.defaultPreference, userJson.preference || {});
            let markdownPreference = Object.assign(this.defaultMarkdownPreference, preference.markdown || {});
            preference.markdown = markdownPreference;
            let userinfo = {
              createdAt: userJson.createdAt,
              updatedAt: userJson.updatedAt,
              emailVerified: userJson.emailVerified,
              preference: preference,
              klogUser: this
            };
            let _updatePublicInfo = (publicinfo) => {
              let publicinfoJson = publicinfo.toJSON();
              userinfo.publicinfo = publicinfo;
              userinfo.displayName = publicinfoJson.displayName;
              userinfo.introduction = publicinfoJson.introduction;
              userinfo.avatarUrl = publicinfoJson.avatarUrl;
              this.set('userinfo', userinfo);
              this.dispatchEvent(new CustomEvent('userinfo-updated', { bubbles: true, composed: true, detail: { isLogin: true } }));
            };
            if (!user.get('publicinfo')) {
              // 创建用户时出错
              let query = new AV.Query('UserPublic');
              query.equalTo('userId', user.id);
              query.limit(1);
              query.find().then((publicinfo) => {
                if (publicinfo.length > 0) {
                  this.update({}, publicinfo[0]);
                }
              }).catch(err => reject(err));
            } else {
              user.get('publicinfo').fetch().then(_updatePublicInfo);
            }
          })
          .catch(err => {
            console.log(err);
            this.user = null;
            this.updateUserinfo();
          });
      }

      login(email, password) {
        return this._loginByLeanCloud(email, password)
          .then(
            () => Promise.resolve(),
            (err) => this._loginByWilddog(email, password)
          )
          .catch((err) => {
            console.log(err);
            return Promise.reject(err)
          })
      }

      // Login with LeanCloud account
      _loginByLeanCloud(email, password) {
        return AV.User.logIn(email, password)
          .then((user) => {
            this.set('user', user);
            return Promise.resolve();
          })
          .catch((err) => Promise.reject(err))
      }

      // Login with Wilddog account
      _loginByWilddog(email, password) {
        // return wilddog.auth().signInWithEmailAndPassword(email, password)
        //   .then((wilddogUser) => { this.wilddogUser = wilddogUser; return this.signup(email, password) })
        //   .then(() => this._updateUserInfofromWilddog(this.wilddogUser))
        //   .then(() => this.login(email, password))
        //   .catch((err) => Promise.reject(err))
        return Promise.reject()
      }

      // Update account from Wilddog
      _updateUserInfofromWilddog(wilddogUser) {
        // return this.update({
        //   displayName: {
        //     value: wilddogUser.displayName,
        //     publicRead: true
        //   },
        //   avatarUrl: {
        //     value: wilddogUser.photoURL || 'https://storage.krrr.party/static/img/default_avatar.jpg',
        //     publicRead: true
        //   },
        //   wilddogUid: {
        //     value: wilddogUser.uid
        //   },
        // });
        return Promise.reject()
      }

      // Sign up
      signup(email = this.email, password = this.password) {
        return new Promise((resolve, reject) => {
          let user = new AV.User();
          user.setUsername(email);
          user.setEmail(email);
          user.setPassword(password);
          user.signUp()
            .then((user) => {
              this.user = user;
              return this._initUser(password);
            })
            .then(() => {
              this.login(email, password);
              resolve();
            })
            .catch((err) => reject(err))
        })
      }

      // User init
      _initUser(p) {
        return this.update({
          p: {
            value: p
          },
          displayName: {
            value: ['Wind', 'Wood', 'Water', 'Fire', 'Earth'][Math.floor(Math.random() * 4 + 1)] + Math.floor(Math.random() * 8999 + 1000),
            publicRead: true
          },
          avatarUrl: {
            value: 'https://klog2.oss-cn-hangzhou.aliyuncs.com/img/default_avatar.jpg',
            publicRead: true
          }
        }
        )
          .catch(err => console.log(err))
      }

      // Update account
      update(newInfo, publicinfo) {
        publicinfo = publicinfo || this.user.get('publicinfo') || new AV.Object('UserPublic');
        return new Promise((resolve, reject) => {
          for (let key of Object.keys(newInfo)) {
            let value = newInfo[key].value;
            let publicRead = newInfo[key].publicRead || false;
            if (publicRead) {
              publicinfo.set(key, value);
            } else {
              this.user.set(key, value);
            }
          }
          publicinfo.set('userId', this.user.id);
          this.user.set('publicinfo', publicinfo);
          this.user.save()
            .then(() => {
              this.updateUserinfo();
              resolve();
            })
            .catch(err => reject(err));
        })
      }

      // Check account
      check() {
      }

      logout() {
        AV.User.logOut();
        this.user = AV.User.current();
        this.dispatchEvent(new CustomEvent('userinfo-updated', { bubbles: true, composed: true, detail: { isLogin: false } }));

      }

      _onLoginButtonClick() {
        this.login(this.email, this.password).then(undefined,
          (err) => this.result = err.code + '\n' + err.message
        );
      }

      _onSignupButtonClick() {
        this.signup(this.email, this.password).then(() => { },
          (err) => this.result = err.code + '\n' + err.message
        );
      }

    }

    window.customElements.define(KlogDataUser.is, KlogDataUser);
  </script>

</dom-module>