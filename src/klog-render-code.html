<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../static/lib/prism/prism-style.html">
<link rel="import" href="klog-style-scrollbar.html">

<dom-module id="klog-render-code">
  <template>
    <style include="klog-style-scrollbar"></style>
    <style include="prism-style"></style>
    <style>
      :host {
        display: block;
      }

      code,
      pre {
        font-family: Menlo, Monaco, Consolas, "Andale Mono", "lucida console", "Courier New", -apple-system, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "Wenquanyi Micro Hei", "WenQuanYi Zen Hei", "ST Heiti", SimHei, "WenQuanYi Zen Hei Sharp", sans-serif !important;
      }

      pre {
        position: relative;
        margin-top: 28px;
        padding: 0;
        line-height: 1.5;
        text-align: left;
        white-space: pre;
        word-spacing: normal;
        word-break: normal;
        word-wrap: normal;
        -moz-tab-size: 4;
        -o-tab-size: 4;
        tab-size: 4;
        border-radius: 5px;
        background: var(--klog-markdown-block-color);
      }

      pre code {
        display: block;
        width: 100%;
        padding: 16px;
        overflow: auto;
        box-sizing: border-box;
      }

      :not(pre)>code,
      .klog-article-content>code {
        padding: 1px 4px;
        border-radius: 3px;
        word-break: break-all;
        white-space: normal;
      }

      :host(.has-meta) code {
        padding-top: 24px;
      }

      :host(.overflow-code) code {
        max-height: 80vh;
        overflow-y: scroll;
      }

      .meta {
        padding: 0 16px;
      }

      .meta>* {
        padding: 2px 10px;
        border-radius: 5px;
        font-size: 0.875em;
        background: var(--primary-color);
        color: var(--klog-markdown-block-color);
        user-select: none;
        cursor: default;
        position: absolute;
        top: -12px;
        @apply(--shadow-elevation-4dp);
      }

      pre code:first-child {
        padding-top: 0;
      }
    </style>
    <div id="container" theme$="[[theme]]">
      <pre
        id="pre"><template is="dom-if" if="{{lang}}"><div class="meta"><span class="code-lang">{{lang}}</span></div></template><code id="code"></code></pre>
    </div>
  </template>

  <script src="../static/lib/prism/prism.min.js"></script>
  <script>
    class KlogRenderCode extends Polymer.Element {

      static get is() { return 'klog-render-code'; }

      static get properties() {
        return {
          lang: {
            type: String,
            value: ''
          },
          code: {
            type: String,
            value: ''
          },
          theme: {
            type: String,
            value: 'dark',
            reflectToAttribute: true,
          }
        }
      }

      ready() {
        super.ready();
        if (Prism) {
          this.update();
        } else {
          console.error('Prism not found');
        }
      }

      update() {
        this.lang = this.lang.replace(/cpp/i, 'c++').toUpperCase();
        let highlightLang = this.lang in Prism.languages ? lang : 'clike';
        let grammar = Prism.languages[highlightLang];
        this.highlightCode = Prism.highlight(unescape(this.code), grammar, highlightLang) || '';
        this.$.container.setAttribute('theme', this.theme);
        this.$.pre.classList.add(`language-${this.lang}`);
        this.$.code.innerHTML = this.highlightCode;
      }

    }

    window.customElements.define(KlogRenderCode.is, KlogRenderCode);
  </script>

</dom-module>