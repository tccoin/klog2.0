<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-layout/app-layout.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="klog-icons.html">
<link rel="import" href="klog-style-login.html">
<link rel="import" href="klog-style-dialog.html">
<link rel="import" href="klog-input.html">
<dom-module id="klog-signup">
  <template>
    <style include="klog-style-login"></style>
    <style include="klog-style-dialog"></style>
    <app-header fixed>
      <app-toolbar>
        <paper-icon-button icon="menu" on-click="openDrawer"></paper-icon-button>
      </app-toolbar>
    </app-header>
    <paper-dialog id="dialog" with-backdrop>
      <h2>注册之前…</h2>
      <p>
        请放心，您的密码将不会被明文保存。
        <br><br>
        此外，您的所有个人信息均不会与第三方共享。
        <br><br>
        热忱地欢迎您。
      </p>
      <div class="actions">
        <paper-button primary dialog-confirm>了解</paper-button>
      </div>
    </paper-dialog>
    <div class="login-card">
      <div class="titles">
        <h2 name="welcome">注册条款：<br>一、您无权得知条款内容</h2>
        <h1 name="loading">登记中……</h1>
        <h1 name="success">拿好，<br>你的新人卡来了。</h1>
        <h1 name="error_email_format">这个邮箱地址…<br>好像哪里不对？</h1>
        <h1 name="error_info">大哥！<br>两个框你都填不好？</h1>
        <h1 name="error_email_taken">这个邮箱已经注册过了<br>直接<a href="#/login">登录</a>试试？</h1>
      </div>
      <div class="form">
        <klog-input label="邮箱地址" name="email" value="{{email}}" outlined></klog-input>
        <klog-input id="passwordInput" label="密码" name="password" value="{{password}}" outlined></klog-input>
      </div>
      <div class="actions">
        <paper-icon-button id="go" icon="done" on-click="signup" primary></paper-icon-button>
        <paper-menu-button>
          <paper-icon-button icon="more_horiz" slot="dropdown-trigger"></paper-icon-button>
          <paper-listbox slot="dropdown-content">
            <paper-item on-click="login">登录</paper-item>
          </paper-listbox>
        </paper-menu-button>
      </div>
    </div>
  </template>
  <script>
    class KlogSignup extends Polymer.Element {

      static get is() { return 'klog-signup'; }

      static get properties() {
        return {
          email: {
            type: String,
            value: ''
          },
          password: {
            type: String,
            value: ''
          },
          title: {
            type: String,
            value: 'welcome',
            observer: '_titleChanged'
          },
        }
      }

      openDrawer() {
        this.dispatchEvent(new CustomEvent('drawer-toggle', { bubbles: true, composed: true }));
      }

      ready() {
        super.ready();
        this.$.passwordInput.addEventListener('keyup', (e) => {
          if (e.keyCode == 13) this.login();
        });
        this.$.go.addEventListener('mousedown', function () {
          this.shadowRoot.querySelector('#ink').classList.remove('circle');
        });
      }

      load(app) {
        document.title = '注册 - Klog';
        this.title = 'welcome';
        this.user = app.$.user;
        this.continue = this.continue || '#/timeline';
        this.$.dialog.open();
      }

      signup() {
        this.title = 'loading';
        this.user.signup(this.email, this.password).then(() => {
          this.title = 'success';
          setTimeout(() => {
            this.dispatchEvent(new CustomEvent('klog-app-load', { bubbles: true, composed: true, detail: { page: this.continue } }));
          }, 1500);
        }, err => {
          window.err = err;
          if (err) {
            if (err.code == 125) {
              this.title = 'error_email_format';
            } else if (err.code == 203) {
              this.title = 'error_email_taken';
            } else {
              this.title = 'error_info';
            }
          } else {
            this.title = 'error_info';
          }

        });
      }

      login() {
        this.dispatchEvent(new CustomEvent('user-login-page-open', {
          bubbles: true,
          composed: true,
          detail: { continue: this.continue }
        }));
      }

      _titleChanged(title) {
        this.shadowRoot.querySelector(`h1[name=${title}],h2[name=${title}]`).classList.remove('hidden');
        for (let element of this.shadowRoot.querySelectorAll(`h1[name],h2[name]`)) {
          if (element.getAttribute('name') != title) element.classList.add('hidden')
        }
      }

    }

    window.customElements.define(KlogSignup.is, KlogSignup);
  </script>
</dom-module>