<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-storage/app-localstorage/app-localstorage-document.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="klog-style-layout.html">
<link rel="import" href="klog-style-card.html">
<link rel="import" href="klog-markdown.html">
<link rel="import" href="klog-data-editor.html">
<link rel="import" href="klog-input.html">
<link rel="import" href="klog-data-list.html">
<link rel="import" href="klog-image.html">

<dom-module id="klog-lab">
  <template>
    <style include="klog-style-layout"></style>
    <style include="klog-style-card"></style>
    <style>
      :host {
        display: block;
        background-color: var(--klog-page-background);
      }

      .main-container {
        max-height: 500px;
        max-width: 720px;
        margin: 32px auto;
        padding: 16px;
        overflow: auto;
      }

      textarea {
        height: calc(60vh - 72px);
        padding: 8px;
        width: 100%;
        box-sizing: border-box;
      }
    </style>
    <app-localstorage-document key="masterKey" data="{{masterKey}}"></app-localstorage-document>
    <app-localstorage-document key="articleId" data="{{articleId}}"></app-localstorage-document>
    <!-- <klog-data-editor id="data" markdown="{{markdown}}" quiet data="{{article}}"></klog-data-editor> -->
    <klog-data-list id="list" last-response="{{list}}" limit="1000"></klog-data-list>
    <div class="klog-card main-container">
      <klog-input outlined value="{{masterKey}}" label="Master Key"></klog-input>
      <klog-input outlined value="{{articleId}}" label="Article Id"></klog-input>
      <klog-input outlined value="{{article.title}}" label="Title"></klog-input>
      <paper-button on-click="login">登录</paper-button>
      <paper-button on-click="loadList">加载列表</paper-button>
      <paper-button on-click="loadArticle">打开文章</paper-button>
      <paper-button on-click="saveArticle">保存文章</paper-button>
      <br>
      <paper-button on-click="loadNext">打开下一篇文章</paper-button>
      <paper-button on-click="saveNext">更新下一篇文章</paper-button>
      <paper-button on-click="saveList">更新所有文章</paper-button>
      <paper-button on-click="updateImageInfo">更新所有图片信息</paper-button>
      <paper-toggle-button checked="{{stop}}">急停</paper-toggle-button>
    </div>
    <div class="klog-card main-container">
      <paper-progress value="[[listProgress]]"></paper-progress>
      等待处理：{{list.length}}
    </div>
    <div class="klog-card main-container">
      {{article.updatedAt}}:{{listProgressDelta}}
      <klog-markdown id="markdown" markdown="{{markdown}}"></klog-markdown>
    </div>
    <div class="klog-card main-container">
      <textarea value="{{markdown::input}}"></textarea>
    </div>
  </template>

  <script>
    class KlogLab extends Polymer.Element {

      static get is() { return 'klog-lab'; }

      ready() {
        super.ready();
        this.addEventListener('app-load', (e) => {
          e.stopPropagation();
        });
        this.listProgress = 0;
        AV._config.useMasterKey = true;
        this.$.image = document.createElement('klog-image');
        console.log(this);
        this._editor = this._createEditor();
      }

      login() {
        window.process = { env: { CLIENT_PLATFORM: 'hahaha' } };
        AV.masterKey = this.masterKey;
      }

      async loadArticle() {
        this._editor.articleId = this.articleId;
        await this._editor.load();
        this.article = this._editor.data;
        this.markdown = this._editor.markdown;
      }

      saveArticle() {
        return this._editor.save();
      }

      loadList() {
        this.$.list.select = ['title', 'text', 'path', 'collection', 'keywords', 'attachments'];
        this.$.list.load().then(() => {
          this.listProgressDelta = 100 / this.list.length;
          this.listProgress = 0;
          console.log(this.listProgressDelta, this.list.length);
        });
      }

      loadNext() {
        if (this.list.length > 0) {
          this.articleId = this.pop('list').objectId;
          this.loadArticle();
        }
      }

      saveNext() {
        if (this.list.length > 0) {
          this.articleId = this.pop('list').objectId;
          this.loadArticle().then(() => this.saveArticle());
        }
      }

      _createEditor() {
        const editor = document.createElement('klog-data-editor');
        editor.quiet = true;
        return editor;
      }

      updateImageInfo() {
        for (let i = 0; i < 4; i++) {
          this._updateImageInfo(i);
        }
      }

      async _updateImageInfo(i) {
        const editor = this._createEditor();
        while (this.list && this.list.length > 0) {
          if (this.stop) return;
          let article = this.pop('list');
          if (article.attachments.length == 0) continue;
          for (let image of article.attachments.filter(x => x.image)) {
            let req = new XMLHttpRequest();
            await this.$.image.loadPlaceholder(this.$.image.encode(image.url), true);
          }
          editor.articleId = article.objectId;
          await editor.load();
          this.article = editor.data;
          this.markdown = editor.markdown;
          await editor.save();
          // window.e = editor;
          // console.log(window.e);
        }
      }

      saveList() {
        const editor = this._createEditor();
        if (this.stop) return;
        if (this.list.length > 0) {
          this.articleId = this.pop('list').objectId;
          // this.loadArticle().then(() => true).then(() => this.saveList());
          this.loadArticle().then(() => this.saveArticle()).then(() => this.saveList());
        }
        this.listProgress += this.listProgressDelta;
      }

    }

    window.customElements.define(KlogLab.is, KlogLab);
  </script>
</dom-module>